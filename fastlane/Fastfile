fastlane_version "2.36.0"

default_platform :ios

platform :ios do
  before_all do
    cocoapods(repo_update: true)
  end

  desc "Runs all the tests"
  lane :test do
    scan(scheme: "QOT")
  end

  desc "Deploy to Crashlytics Beta"
  lane :cbeta do
    # Install certificates and profiles
    match(type: "adhoc", readonly: true)

    # Build
    gym(scheme: "QOT")

    # upload to Beta by Crashlytics
    crashlytics(
      api_token: "c5b6a77e0ac832aeb121a8444afaba1522a28469",
      build_secret: "d4ca106b8d4d308cc6c505618f78c345e3e6bd462c0bd7a433abfc3f733a4783"
    )
  end

  desc "Deploy to Hockeyapp"
  lane :beta do
    
    # Install certificates and profiles
    sigh(force: false)

    increment_build_number(build_number: ENV["BITRISE_BUILD_NUMBER"])

    # Build
    gym(scheme: "QOT")

    # Release to hockey app
    hockey(api_token: ENV["HOCKEYAPP_API_TOKEN"])
  end

  desc "Build and deploy to AWS S3 and hockey"
  lane :release do
    
    # Install certificates and profiles
    sigh(force: false)

    increment_build_number(build_number: ENV["BITRISE_BUILD_NUMBER"])

    # Build
    gym(
      scheme: "QOT",
    )

    #Release to AWS S3
    aws_s3(
      access_key: ENV['S3_ACCESS_KEY'],
      secret_access_key: ENV['S3_SECRET_ACCESS_KEY'],
      bucket: ENV['S3_BUCKET'],
      region: ENV['S3_REGION'],
      ipa: ENV['S3_IPA_NAME'],
      app_directory: ENV['S3_APP_DIRECTORY'], # DON'T DELETE! This stops us overwriting original QOT app.
      upload_metadata: true # Upload version.json, plist and HTML. Set to false to skip uploading of these files.
    )

    # Release to hockey app
    hockey(api_token: ENV["HOCKEYAPP_API_TOKEN"])
  end

  after_all do |lane|
    # This block is called, only if the executed lane was successful
  end

  error do |lane, exception|
    # Do something
  end
end
